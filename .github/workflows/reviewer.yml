name: Conditional Approval for SQL PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  auto_approve:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the PR's code
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Analyze SQL files in the PR for CREATE statements
    - name: Analyze SQL files for CREATE statements
      id: analyze_sql
      run: |
        # Fetch changed files from the PR
        changed_files=$(jq -r '.pull_request.changed_files[] | select(contains(".sql"))' <<<"${{ toJSON(github.event) }}")
        create_found=false
        
        # Loop through each changed SQL file and check for CREATE statements
        for file in $changed_files; do
          if grep -iq "CREATE " "$file"; then
            create_found=true
            break
          fi
        done
        
        # Set the result as an environment variable
        echo "create_found=$create_found" >> "$GITHUB_ENV"
        
    # Step 3: Automatically approve the PR if no CREATE statements are found
    - name: Auto-approve PR if no CREATE statements found
      if: env.create_found == 'false'
      uses: hmarr/auto-approve-action@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
