name: Conditional Approval for SQL PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  auto_approve:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the PR's code
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Analyze SQL files in the PR for CREATE statements
    - name: Analyze SQL files for CREATE statements
      id: analyze_sql
      run: |
        # Fetch changed files from the PR
        changed_files=$(jq -r '.pull_request.changed_files[] | select(contains(".sql"))' <<<"${{ toJSON(github.event) }}")
        create_found=false
        
        # Loop through each changed SQL file and check for CREATE statements
        for file in $changed_files; do
          if grep -iq "CREATE " "$file"; then
            create_found=true
            break
          fi
        done
        
        # Set the result as an environment variable
        echo "create_found=$create_found" >> "$GITHUB_ENV"
        
    # Step 3: Auto-approve the PR if no CREATE statements are found, and add bot as reviewer
    - name: Auto-approve PR if no CREATE statements found
      if: env.create_found == 'false'
      run: |
        echo "No CREATE statements found. Adding GitHub Bot as a reviewer and auto-approving the PR."
        # Add GitHub bot as reviewer
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"reviewers":["github-bot"]}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers"
        
        # Auto-approve the PR
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"event":"APPROVE"}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews"

    # Step 4: Add 'notyou1231' as a reviewer if CREATE statements are found
    - name: Add 'notyou1231' as reviewer if CREATE statement is found
      if: env.create_found == 'true'
      run: |
        echo "CREATE statements found. Adding 'Notyou1231' as a reviewer."
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"reviewers":["Notyou1231"]}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers"
