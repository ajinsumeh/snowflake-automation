name: Conditional Approval for SQL PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
    paths:
      - '.github/sql_scripts/**'  # Specify the path where your SQL scripts are located

jobs:
  auto_approve:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the PR's code
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Analyze SQL files in the PR for CREATE statements
    - name: Analyze SQL files for CREATE statements
      id: analyze_sql
      run: |
        # Fetch changed files from the PR
        changed_files=$(jq -r '.pull_request.changed_files[] | select(contains(".sql"))' <<<"${{ toJSON(github.event) }}")
        create_found=false
        
        # Loop through each changed SQL file and check for CREATE statements
        for file in $changed_files; do
          if grep -iq "CREATE " "$file"; then
            create_found=true
            break
          fi
        done
        
        # Set the result as an environment variable
        echo "create_found=$create_found" >> "$GITHUB_ENV"

    # Step 3: Auto-approve PR if no CREATE statements found
    - name: Auto-approve PR if no CREATE statements found
      if: env.create_found == 'false'
      uses: hmarr/auto-approve-action@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
      
    # Step 4: Request review if CREATE statements are found
    - name: Request review from notyou1231 if CREATE statements are found
      if: env.create_found == 'true'
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"reviewers":["Notyou1231"]}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers"
